name: Add Secret to Vault

on:
  workflow_dispatch:
    inputs:
      secret_name:
        description: 'Key name in Vault (must match GitHub Secret name)'
        required: true
        type: choice
        options:
          - github_token
          - cloudflare_token
          - datadog_api_key
          # Add new secrets here as they're documented in README

jobs:
  add-secret:
    runs-on: self-hosted
    steps:
      - name: Checkout deployments (for Helm chart)
        uses: actions/checkout@v4
        with:
          repository: antonioacg/deployments
          path: deployments

      - name: Map secret value
        id: secret
        run: |
          # Explicit mapping - GitHub doesn't support dynamic secret indexing
          case "${{ github.event.inputs.secret_name }}" in
            github_token)      echo "value=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT ;;
            cloudflare_token)  echo "value=${{ secrets.CLOUDFLARE_TOKEN }}" >> $GITHUB_OUTPUT ;;
            datadog_api_key)   echo "value=${{ secrets.DATADOG_API_KEY }}" >> $GITHUB_OUTPUT ;;
            *) echo "Unknown secret" && exit 1 ;;
          esac

      - name: Create Vault secret writer job
        run: |
          helm template vault-secret-writer \
            deployments/clusters/production/vault-jobs \
            --set secretName="${{ github.event.inputs.secret_name }}" \
            --set secretValue="${{ steps.secret.outputs.value }}" \
            | kubectl apply -f -
