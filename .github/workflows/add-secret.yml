name: Add Secret to Vault

on:
  workflow_dispatch:
    inputs:
      vault_path:
        description: 'Full Vault path (e.g., production/cloudflare/token)'
        required: true
        type: string
      key_name:
        description: 'Key name within the Vault path (e.g., token)'
        required: true
        type: string
      github_secret:
        description: 'GitHub Secret to use as value'
        required: true
        type: choice
        options:
          - GITHUB_TOKEN
          - CLOUDFLARE_TOKEN
          - DATADOG_API_KEY
          # Add new secrets here — also add the case mapping below

jobs:
  add-secret:
    runs-on: self-hosted
    steps:
      - name: Validate namespace prefix
        run: |
          path="${{ github.event.inputs.vault_path }}"
          case "$path" in
            platform/*|production/*|recovery/*)
              echo "Valid path prefix: $path"
              ;;
            *)
              echo "ERROR: Invalid path prefix. Must start with platform/, production/, or recovery/" >&2
              exit 1
              ;;
          esac

      - name: Checkout deployments (for Helm chart)
        uses: actions/checkout@v4
        with:
          repository: antonioacg/deployments
          path: deployments

      - name: Map secret value
        id: secret
        run: |
          # Explicit mapping — GitHub doesn't support dynamic secret indexing
          case "${{ github.event.inputs.github_secret }}" in
            GITHUB_TOKEN)      echo "value=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT ;;
            CLOUDFLARE_TOKEN)  echo "value=${{ secrets.CLOUDFLARE_TOKEN }}" >> $GITHUB_OUTPUT ;;
            DATADOG_API_KEY)   echo "value=${{ secrets.DATADOG_API_KEY }}" >> $GITHUB_OUTPUT ;;
            *) echo "Unknown secret: ${{ github.event.inputs.github_secret }}" && exit 1 ;;
          esac

      - name: Create Vault secret writer job
        run: |
          helm template vault-secret-writer \
            deployments/clusters/production/vault-jobs \
            --set vault.path="secret/${{ github.event.inputs.vault_path }}" \
            --set secretName="${{ github.event.inputs.key_name }}" \
            --set secretValue="${{ steps.secret.outputs.value }}" \
            | kubectl apply -f -
