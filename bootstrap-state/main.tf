# Bootstrap State Infrastructure - Phase 1 ONLY
# Purpose: Minimal infrastructure for Terraform state backend
# Creates: k3s + MinIO + PostgreSQL ONLY - NO Vault (Phase 2)

terraform {
  required_version = ">= 1.0"

  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.0"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.0"
    }
    null = {
      source  = "hashicorp/null"
      version = "~> 3.0"
    }
  }
}

# Bootstrap namespace
# NOTE: k3s installation handled by bootstrap-phase1.sh script
resource "kubernetes_namespace" "bootstrap" {
  metadata {
    name = "bootstrap"
  }
}

# MinIO credentials are generated by bootstrap script
# and passed as variables to this Terraform configuration

# MinIO for Terraform state storage
resource "helm_release" "bootstrap_minio" {
  name       = "bootstrap-minio"
  repository = "https://charts.min.io/"
  chart      = "minio"
  namespace  = "bootstrap"
  version    = "5.0.15"

  create_namespace = true

  values = [yamlencode({
    mode = var.node_count == 1 ? "standalone" : "distributed"
    replicas = var.node_count
    auth = {
      rootUser     = var.minio_access_key
      rootPassword = var.minio_secret_key
    }
    defaultBuckets = "terraform-state,vault-storage,vault-backups"
    persistence = {
      enabled      = true
      size         = var.minio_storage_size
      storageClass = "local-path"
    }
    service = {
      type = "ClusterIP"
      ports = {
        api     = 9000
        console = 9001
      }
    }
    resources = {
      requests = {
        memory = "256Mi"
        cpu    = "100m"
      }
      limits = {
        memory = "512Mi"
        cpu    = "500m"
      }
    }
  })]

  depends_on = [kubernetes_namespace.bootstrap]
}

# PostgreSQL for state locking (ARM64 compatible)
resource "helm_release" "bootstrap_postgresql" {
  name       = "bootstrap-postgresql"
  repository = "https://charts.bitnami.com/bitnami"
  chart      = "postgresql"
  namespace  = "bootstrap"
  version    = "13.2.24"

  create_namespace = true

  values = [yamlencode({
    auth = {
      postgresPassword = "postgres123"
      database         = "terraform_locks"
    }
    primary = {
      persistence = {
        enabled      = true
        size         = "8Gi"
        storageClass = "local-path"
      }
      resources = {
        requests = {
          memory = "256Mi"
          cpu    = "100m"
        }
        limits = {
          memory = "512Mi"
          cpu    = "250m"
        }
      }
    }
  })]

  depends_on = [kubernetes_namespace.bootstrap]
}
